<!doctype html>
<html>
  <head>
    <title>Socket.IO Chat Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #messages {
        height: 300px;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        overflow-y: auto;
      }
      #messageInput {
        width: 70%;
        padding: 5px;
      }
      button {
        padding: 5px 10px;
        margin-left: 10px;
      }
      .status {
        color: #666;
        font-style: italic;
        min-height: 20px;
        margin-bottom: 10px;
      }
      .input-group {
        margin-bottom: 10px;
      }
      .message {
        margin-bottom: 5px;
        padding: 5px;
        border-radius: 5px;
        background-color: #f0f0f0;
      }
      .message.sent {
        background-color: #e3f2fd;
        margin-left: 20%;
      }
      .message.received {
        background-color: #f5f5f5;
        margin-right: 20%;
      }
      .typing-indicator {
        display: flex;
        align-items: center;
        margin: 5px 0;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border-radius: 5px;
        font-size: 14px;
        color: #666;
      }
      .typing-team-name {
        font-weight: bold;
        color: #2196f3;
        margin-right: 5px;
      }
      .typing-dots {
        display: flex;
        margin-left: 5px;
      }
      .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #666;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite;
      }
      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-5px);
        }
      }
    </style>
  </head>
  <body>
    <h1>Socket.IO Chat Test</h1>
    <div class="input-group">
      <label for="teamId">Team ID:</label>
      <input type="text" id="teamId" placeholder="Enter your team ID" />
    </div>
    <div class="input-group">
      <label for="matchId">Match ID:</label>
      <input type="text" id="matchId" placeholder="Enter match ID" />
      <button onclick="joinMatch()">Join Match</button>
    </div>
    <div id="messages"></div>
    <div id="typingStatus" class="status"></div>
    <div>
      <input type="text" id="messageInput" placeholder="Type a message" />
      <button onclick="sendMessage()">Send</button>
    </div>

    <script>
      let currentTeamId = '';
      const socket = io('http://localhost:3000', {
        transports: ['websocket'],
      });

      // Connection events
      socket.on('connect', () => {
        logMessage('Connected to server', 'system');
      });

      socket.on('disconnect', () => {
        logMessage('Disconnected from server', 'system');
      });

      socket.on('connect_error', (error) => {
        logMessage('Connection error: ' + error.message, 'error');
      });

      socket.on('welcome', (data) => {
        logMessage('Server: ' + data.message, 'system');
      });

      // Chat events
      socket.on('new-message', (message) => {
        const isSent = message.senderTeam._id === currentTeamId;
        logMessage(
          `${message.senderTeam.teamName}: ${message.content}`,
          isSent ? 'sent' : 'received'
        );
      });

      socket.on('typing', (data) => {
        const typingStatus = document.getElementById('typingStatus');
        if (data.isTyping) {
          typingStatus.innerHTML = `
                    <div class="typing-indicator">
                        <span class="typing-team-name">${data.teamName}</span> is typing
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
        } else {
          typingStatus.innerHTML = '';
        }
      });

      socket.on('joined-room', (data) => {
        logMessage(`Joined room: ${data.matchId}`, 'system');
      });

      // Functions
      function joinMatch() {
        const teamId = document.getElementById('teamId').value;
        const matchId = document.getElementById('matchId').value;

        if (!teamId) {
          alert('Please enter your team ID');
          return;
        }

        if (!matchId) {
          alert('Please enter a match ID');
          return;
        }

        currentTeamId = teamId;
        socket.emit('join-match', matchId);
        logMessage(`Joining match ${matchId} as team ${teamId}`, 'system');
      }

      function sendMessage() {
        const matchId = document.getElementById('matchId').value;
        const teamId = document.getElementById('teamId').value;
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value;

        if (!teamId) {
          alert('Please enter your team ID');
          return;
        }

        if (!matchId) {
          alert('Please join a match first');
          return;
        }

        if (!content) {
          alert('Please enter a message');
          return;
        }

        socket.emit('new-message', {
          matchId: matchId,
          message: {
            content: content,
            senderTeam: teamId,
          },
        });
        messageInput.value = '';
      }

      function logMessage(message, type = 'system') {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.textContent = message;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Typing indicator
      let typingTimeout;
      const messageInput = document.getElementById('messageInput');

      messageInput.addEventListener('input', () => {
        const matchId = document.getElementById('matchId').value;
        const teamId = document.getElementById('teamId').value;

        if (matchId && teamId) {
          socket.emit('typing', {
            matchId: matchId,
            userId: teamId,
            isTyping: true,
          });

          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            socket.emit('typing', {
              matchId: matchId,
              userId: teamId,
              isTyping: false,
            });
          }, 1000);
        }
      });

      // Clear typing indicator when input is empty
      messageInput.addEventListener('keyup', () => {
        if (!messageInput.value) {
          const matchId = document.getElementById('matchId').value;
          const teamId = document.getElementById('teamId').value;

          if (matchId && teamId) {
            socket.emit('typing', {
              matchId: matchId,
              userId: teamId,
              isTyping: false,
            });
          }
        }
      });
    </script>
  </body>
</html>
